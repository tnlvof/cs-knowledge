# Feature Specification: 랭킹 · 예상연봉 · 레벨다운 · 정답률

**Feature Branch**: `002-ranking-salary-leveldown`
**Created**: 2026-02-13
**Status**: Draft
**Input**: PRD.md v1.5.1 변경분 (v1.4.1 ~ v1.5.1)
**Depends On**: `001-cs-quiz-rpg` (기존 핵심 기능 전제)

## Overview

기존 메AI플스토리 MVP(001)에 4가지 기능을 추가한다:

1. **랭킹 시스템** - 종합/주간/분야별/콤보/명예의전당 + 시즌제로 경쟁심리 유발
2. **예상 연봉** - 한국고용정보원 공공데이터 기반 분야별 연봉 산출 → 프로필/공유 카드에 표시
3. **레벨 다운 + 오답 페널티** - 기존 오답 +10 EXP → -50 EXP 감소 + 레벨/전직 강등
4. **문제별 정답률** - 퀴즈 화면에 전체 유저 정답률 실시간 표시
5. **패키지 매니저 Bun 전환** - pnpm → Bun

## Clarifications

- 랭킹은 로그인 유저만 참여 가능, 비로그인 유저는 랭킹 열람만 가능
- 시즌 1주기 = 4주(월 단위). 시즌 전환은 Supabase cron 또는 Edge Function으로 자동화
- 예상 연봉은 게임적 재미 수치이며, "실제 직군 중위 임금 기준" 출처를 반드시 표기
- 레벨 다운 시 Lv.1 / EXP 0 미만으로는 내려가지 않음
- 문제별 정답률은 questions 테이블에서 실시간 집계 (별도 캐싱 불필요, MVP 규모)

## User Scenarios & Testing

### User Story 8 - 랭킹 시스템 (Priority: P2)

전체 유저 중 나의 위치를 확인하고, 바로 위 유저를 추월하기 위해 퀴즈를 더 푼다. 주간 랭킹은 매주 초기화되어 누구나 1위 가능성이 있다. 시즌 종료 시 상위 유저는 명예의 전당에 영구 등록된다.

**Why this priority**: 경쟁심리가 리텐션의 핵심 드라이버. 로그인 동기화(US4) 이후에 의미가 있다.

**Independent Test**: 랭킹 화면 → 내 순위 확인 → 퀴즈 풀어서 순위 변동 확인

**Acceptance Scenarios**:

1. **Given** 랭킹 화면 진입, **When** 종합 탭 선택, **Then** 전체 유저 레벨+EXP 순 랭킹 표시 (1~3위 왕관 아이콘)
2. **Given** 랭킹 화면 진입, **When** 주간 탭 선택, **Then** 이번 주 획득 EXP 순 랭킹 표시
3. **Given** 랭킹 화면, **When** 분야 탭(8개 중 선택), **Then** 해당 분야 정답 수+정답률 순 랭킹
4. **Given** 종합 랭킹, **When** 내 순위 주변 표시, **Then** 내 순위 ±5명 하이라이트 + "N위까지 OO EXP" 표시
5. **Given** 퀴즈 정답 후, **When** 랭킹 변동 발생, **Then** 순위 상승 애니메이션 (+N↑)
6. **Given** 시즌 종료, **When** 종합 1~3위 확정, **Then** 명예의 전당 영구 등록 + 한정 칭호 부여
7. **Given** 비로그인 유저, **When** 랭킹 화면, **Then** 열람은 가능하나 본인 순위 없음

---

### User Story 9 - 예상 연봉 (Priority: P3)

캐릭터 프로필과 공유 카드에 레벨+분야별 정답률 기반 예상 IT 연봉이 표시된다. 한국고용정보원 공공데이터의 실제 직업별 중위 임금을 기반으로 산출하여 현실감을 부여한다.

**Why this priority**: 공유/바이럴 유도 강화 기능. 핵심 게임 루프와 독립적.

**Independent Test**: 프로필에서 예상 연봉 확인 → 레벨 변동 시 연봉 변경 확인 → 공유 카드에 연봉 표시 확인

**Acceptance Scenarios**:

1. **Given** 캐릭터 프로필, **When** 화면 표시, **Then** 레벨 구간별 예상 연봉 표시 (예: "예상 연봉: 5,800만원")
2. **Given** 예상 연봉, **When** 산출, **Then** 기준 연봉(레벨 구간) × 분야 보정 계수로 계산
3. **Given** 레벨 다운 발생, **When** 연봉 재계산, **Then** 연봉도 함께 하락
4. **Given** 캐릭터 카드 이미지, **When** 생성, **Then** 예상 연봉 포함
5. **Given** 예상 연봉 표시, **When** 화면 하단, **Then** "실제 OO직군 중위 임금 기준" 출처 표기

---

### User Story 10 - 레벨 다운 + 오답 페널티 (Priority: P1)

오답 시 EXP가 감소하며, EXP가 0 이하로 내려가면 레벨이 하락한다. 고레벨일수록 오답 페널티가 가중되어 레벨 유지 자체가 도전이 된다. 전직 기준 레벨 아래로 떨어지면 직업도 강등된다.

**Why this priority**: 기존 EXP 시스템(001 spec FR-006) 전면 수정. 핵심 게임 밸런스에 직결.

**Independent Test**: 의도적 오답 → EXP 감소 확인 → 연속 오답으로 레벨 다운 확인 → 전직 강등 확인

**Acceptance Scenarios**:

1. **Given** 오답 (score < 0.3), **When** EXP 계산, **Then** 레벨 구간별 EXP 감소 적용 (Lv.1~10: -50, Lv.31~50: -70, Lv.71~90: -150, Lv.91~100: -200)
2. **Given** 연속 3문제 오답, **When** EXP 계산, **Then** 추가 -30 EXP 감소 (총 페널티 = 기본 + 30)
3. **Given** EXP가 0 이하, **When** 레벨 다운 판정, **Then** 레벨 -1 + 이전 레벨 EXP 상한에서 이어서 차감
4. **Given** 레벨 다운 발생, **When** 연출, **Then** "LEVEL DOWN..." 텍스트 + 화면 어두워짐 + 캐릭터 풀죽는 모션
5. **Given** 전직 기준 레벨(10/30/50/70/90) 아래로 하락, **When** 전직 상태 확인, **Then** 이전 직업으로 강등 + 강등 연출
6. **Given** Lv.1 + EXP 0, **When** 추가 오답, **Then** EXP 0에서 더 이상 감소하지 않음 (최저 바닥)
7. **Given** 기존 오답 처리, **When** 001 spec FR-006 "오답 +10 EXP", **Then** 삭제. -EXP로 변경

---

### User Story 11 - 문제별 정답률 표시 (Priority: P2)

퀴즈 화면에서 문제 출제 시 전체 유저 정답률을 함께 보여준다. 채점 후에는 "상위 N%에 해당하는 답변" 정보를 표시한다.

**Why this priority**: 경쟁심리 자극 + 난이도 인지. 기존 전투 UI 위에 표시만 추가하면 됨.

**Independent Test**: 퀴즈 화면에서 정답률 색상 확인 → 채점 후 상위 % 표시 확인

**Acceptance Scenarios**:

1. **Given** 퀴즈 출제, **When** 문제 표시, **Then** "이 문제 정답률: N%" 색상별 표시 (80%+ 초록, 50~79 노랑, 30~49 주황, <30 빨강)
2. **Given** 채점 완료, **When** 결과 표시, **Then** "상위 N%에 해당하는 답변입니다" 표시
3. **Given** 문제 풀이 완료, **When** 정답률 갱신, **Then** questions 테이블의 total_attempts +1, 정답이면 correct_count +1

---

### Edge Cases (추가)

- **레벨 다운 직전 전직 상태**: 전직 기준 레벨 바로 위(예: Lv.30)에서 레벨 다운 → Lv.29 시 2차 전직 해제, 1차 전직으로 복귀
- **시즌 전환 중 퀴즈 풀이**: 시즌 마감 시점에 풀고 있는 퀴즈는 해당 시즌에 반영
- **주간 랭킹 초기화 시점**: 매주 월요일 00:00 KST. Supabase cron으로 profiles.weekly_exp = 0
- **정답률 0% 문제 (신규)**: 아직 아무도 안 푼 문제는 "첫 도전!" 표시 (정답률 대신)
- **연봉 데이터 갱신**: 공공데이터 연 1회 업데이트. 상수 파일에 임베딩, 수동 갱신

## Requirements

### Functional Requirements (001 수정)

- **FR-006 (수정)**: 시스템 MUST EXP 시스템 운영 (정답 100EXP, 부분정답 30~70EXP, **오답 시 레벨 구간별 EXP 감소: -50 ~ -200**, 연속 오답 3문제 시 추가 -30, 콤보 보너스 유지)
- **FR-007 (수정)**: 시스템 MUST 레벨 1~100 성장 시스템 운영 (**레벨 다운 포함**, Lv.1/EXP 0이 최저 바닥)
- **FR-008 (수정)**: 시스템 MUST 전직 시스템 운영 (자동전직 + **강등 포함**. 전직 기준 레벨 아래로 하락 시 이전 직업으로 강등)

### Functional Requirements (신규)

- **FR-025**: 시스템 MUST 종합 랭킹 제공 (레벨+EXP 순, 전체 유저, 실시간)
- **FR-026**: 시스템 MUST 주간 랭킹 제공 (이번 주 EXP 순, 매주 월요일 00:00 KST 초기화)
- **FR-027**: 시스템 MUST 분야별 랭킹 제공 (8개 분야 각각 정답수+정답률 순)
- **FR-028**: 시스템 MUST 연속 정답 랭킹 제공 (역대 최고 콤보 순)
- **FR-029**: 시스템 MUST 내 순위 + 주변 ±5명 조회 기능 제공
- **FR-030**: 시스템 MUST 시즌제 운영 (4주 단위, 종료 시 1~3위 명예의 전당 등록 + 한정 칭호)
- **FR-031**: 시스템 MUST 퀴즈 화면에 문제별 전체 유저 정답률 표시 (색상 구분: 초록/노랑/주황/빨강)
- **FR-032**: 시스템 MUST 채점 결과에 "상위 N%" 표시
- **FR-033**: 시스템 MUST 프로필에 예상 연봉 표시 (레벨 구간 기준 + 분야 보정)
- **FR-034**: 시스템 MUST 예상 연봉을 캐릭터 카드/공유 이미지에 포함
- **FR-035**: 시스템 MUST 레벨 다운 시 "LEVEL DOWN" 연출 표시
- **FR-036**: 시스템 MUST 전직 강등 시 강등 연출 표시
- **FR-037**: 시스템 MUST 랭킹에서 순위 변동 시 애니메이션 표시 (+N↑)
- **FR-038**: 시스템 MUST 주간 랭킹 1위를 IT 빌리지 메인에 "이번 주 최강 모험가"로 노출

### Key Entities (신규/수정)

- **Season**: 시즌 정보 (번호, 시작/종료일, 상태)
- **HallOfFame**: 명예의 전당 (시즌, 유저, 순위, 한정 칭호)
- **CategoryStats**: 분야별 통계 (유저, 분야, 정답수, 총풀이수, 정답률) - 랭킹 집계용
- **Profile (수정)**: estimated_salary, best_combo, weekly_exp 컬럼 추가
- **Question (수정)**: total_attempts, correct_count, accuracy_rate 컬럼 추가

## Non-Functional Requirements

- **NFR-006**: 랭킹 API 응답 500ms 이내 (인덱스 기반 정렬, MVP 규모)
- **NFR-007**: 주간 랭킹 초기화는 사용자 영향 없이 백그라운드 실행 (Supabase cron)
- **NFR-008**: 연봉 산출 로직은 클라이언트 사이드 계산 (API 호출 불필요)

## Assumptions

- 001 spec의 모든 기능(캐릭터, 전투, AI 채점, 로그인, 히스토리, 후원, 공유)이 구현 완료된 상태
- MVP 유저 수(~100명)에서 랭킹 정렬은 PostgreSQL 인덱스만으로 충분 (별도 캐싱 불필요)
- 시즌 자동 전환은 Supabase pg_cron 또는 Edge Function scheduled 사용
- 연봉 데이터는 공공데이터에서 수동 추출 → 상수 파일에 임베딩 (API 실시간 호출 X)
- 패키지 매니저 Bun 전환은 001 quickstart와 모든 스크립트에 반영 필요
